<!DOCTYPE html>
<html lang="en">

<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <meta http-equiv="X-UA-Compatible" content="ie=edge">
     <title>Index 2</title>
     <style>
          body {
               padding: 0;
               margin: 0;
          }

          .container {
               width: 100%;
               height: 100%;
          }

          .archive-map {
               width: 100%;
               height: 50vh;
          }
          div#cat{
               margin: 10px 0px;
          }
          .categorias{
               border: 1px solid gray;
               padding: 3px;
               border-radius: 10px;
               display: inline-block;
               background-color: #565656;
               color: white;
               text-transform: capitalize;
          }
          .nav {
               background: rgba(0, 0, 0, 0.5);
               width: 100%;
               text-align: center;
               margin: 0;
               padding-left: 0;
          }

          .nav li {
               display: inline-block;
          }

          .nav li a {
               color: #fff;
               padding: 10px;
               display: block;
               position: relative;
               z-index: 100;
          }
     </style>
</head>

<body>
     <script
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAGI_jgIJQXJ-0dsWX-W8yindzXIcwO4fw&language=ee&dummy=dummy.js">
     </script>
     <script src="assets/js/xlsx.full.min.js"></script>

     <div class="container">
          <div id="map" class="archive-map"></div>
     </div>
     <div id="app"></div>
     <div id="cat"></div>
     <div id="panel"></div>
     <script>
          let
          jsonRegiones = "regiones.json"
          jsonLocales = "locales.xls"
          mapCanvas = document.getElementById("map")
          panel = document.getElementById("panel")
          cat = document.getElementById("cat")

          chileCords = {
               lng: -71.5429688,
               lat: -35.675148
          }
          markers = []
          infowindow = new google.maps.InfoWindow({
               maxWidth: 200
          })

          //CREACION DE BARRA
          barraTags = document.createElement("div")
          barraTags.setAttribute("id", "cajabotones")
          barraTags.setAttribute("class", "button-group filter-button-group")
          cat.appendChild(barraTags)
          barra = document.getElementById('cajabotones')

          let addMarker = (locales) => {
               map.setZoom(4)
               for (var i = 0; i < locales.length; i++) {
                    let
                         contentString =
                         `<div id="content"><h1> ${locales[i].nombre}</h1><p>Lorem ipsum dolor sit amet, vix mutat posse suscipit id, vel ea tantas omittam detraxit.</p></div>`
                    // console.log(contentString)  
                    let marker = new google.maps.Marker({
                         position: {
                              lat: parseFloat(locales[i].latitud),
                              lng: parseFloat(locales[i].longitud)
                         },
                         map: map,
                         icon: {
                              url: "assets/img/" + locales[i].estado + ".svg",
                              anchor: new google.maps.Point(25, 50),
                              scaledSize: new google.maps.Size(50, 50)
                         },
                         type: "point",
                         id: [i],
                         animation: google.maps.Animation.DROP
                    })
                    // console.log(locales[i].latitud)
                    // Se agregan markers al array
                    markers.push(marker)
                    // marker.setVisible(true)  

                    google.maps.event.addListener(marker, 'click', (function (marker, i) {
                         return function () {
                              infowindow.setContent(contentString)
                              infowindow.open(map, marker)
                              map.panTo(this.getPosition())
                              map.setZoom(17)
                              map.setCenter(marker.getPosition())
                         }
                    })(marker, i))

                    // panel.innerHTML = ``
                    panel.innerHTML +=
                         `
                              <a style="display: block;"class="marker-link" onclick="myClick(${markers.length -1});">
                                   <h2>${locales[i].nombre}</h2>
                                   ${ !locales[i].circunstanciaDeFallecimiento ? "" : `<p><b>Circunstancias:</b> ${locales[i].circunstanciaDeFallecimiento}</p>`}
                                   ${ !locales[i].edad ? "" : `<p><b>edad:</b> ${locales[i].edad}</p>`}

                                   ${ !locales[i].nacionalidad ? "" : `<p><b>nacionalidad:</b> ${locales[i].nacionalidad}</p>`}

                                   ${ !locales[i].fecha ? "" : `<p><b>fecha:</b> ${locales[i].fecha}</p>`}

                                   ${ !locales[i].lugar ? "" : `<p><b>lugar:</b> ${locales[i].lugar}</p>`} 
                              </a>
                         `
               }
          }

          let myClick = id => {
               map.setCenter(markers[id].getPosition())
               google.maps.event.trigger(markers[id], 'click')
               console.log('hice click')
          }

          let limpiarPins = () => {
               for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(null);
               }
               markers.length = 0;
               panel.innerHTML = ``
          }
         

          // CARGA REGIONES //////++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
          fetch(jsonRegiones)
               .then(res => res.json())
               .then(region =>
                    cargaSelect(region)
                    //   console.log(region)
               )
               .catch(err => console.log(err))

          let
               regionesRegistradas = reg => reg.nombreRegion
               comunasRegistradas = reg => reg.comunas
               templateElegirComuna = lugar => `<option value="${lugar}">${lugar}</option>`
               templateRegion = reg =>
               `<option class="optionRegion" value="${reg.nombreRegion}">${reg.nombreRegion}</option> `
          //   let templatePin = pin =>`<div id="siteNotice">${pin.nombre}</div> `

               panelTemplate = locales =>
               `
               <a style="display: block;"class="marker-link" onclick="myClick(${markers.length -1});">
                                   <h2>${locales[i].nombre}</h2>
                                   ${ !locales[i].circunstanciaDeFallecimiento ? "" : `<p><b>Circunstancias:</b> ${locales[i].circunstanciaDeFallecimiento}</p>`}
                                   ${ !locales[i].edad ? "" : `<p><b>edad:</b> ${locales[i].edad}</p>`}

                                   ${ !locales[i].nacionalidad ? "" : `<p><b>nacionalidad:</b> ${locales[i].nacionalidad}</p>`}

                                   ${ !locales[i].fecha ? "" : `<p><b>fecha:</b> ${locales[i].fecha}</p>`}

                                   ${ !locales[i].lugar ? "" : `<p><b>lugar:</b> ${locales[i].lugar}</p>`} 
                              </a>
                         `
               cargaSelect = (region) => {
               //console.log(region.length); 
               app.innerHTML =
                    `
                              <select id="regiones"> 
                              <option value="" disabled selected>Region</option>
                              ${region.map(templateRegion).join('')}
                              </select>
                              <select id="comunas"> 
                              <option value="">Seleccione una Comuna...</option>
                              </select>
                              `

               function cargaComunas() {
                    let padre = this.value
                    // console.log(padre);
                    let com = region.map(regionesRegistradas)
                    // console.log(com);
                    let indice = com.indexOf(padre);
                    // console.log(indice);
                    // Mostrar comuna es un array obtenido de un array de objetos
                    let mostrarComuna = region.map(comunasRegistradas)[indice]

                    console.log(mostrarComuna)
                    //debugger

                    selectComunas.innerHTML =
                         `<option value="">Seleccione una Comuna...</option>${mostrarComuna.map(templateElegirComuna).join(' ')}`;
               }

               let selectRegiones = document.getElementById("regiones")
               let selectComunas = document.getElementById("comunas")

               selectRegiones.addEventListener("change", cargaComunas, false)
               selectComunas.addEventListener("change", cargaUbicacion, false)
          }


          let cargaUbicacion = () => {
               let localCapturado = event.target.value

               fetch(jsonLocales)
                    .then(
                         fail = (res) => {
                              /* get the data as a Blob */
                              if (!res.ok) throw new Error("fetch failed");
                              return res.arrayBuffer();
                         }
                    )
                    .then(
                         load = (ab) => {
                              /* parse the data when it is received */
                              let data = new Uint8Array(ab);
                              let workbook = XLSX.read(data, {
                                   type: "array"
                              });

                              /* DO SOMETHING WITH workbook HERE */
                              let first_sheet_name = workbook.SheetNames[0];
                              /* Get worksheet */
                              let worksheet = workbook.Sheets[first_sheet_name];
                              locales = XLSX.utils.sheet_to_json(worksheet, {
                                   raw: true
                              })
                              cargaLocal(locales), console.log(locales)

                         }
                    )

               function cargaLocal(locales) {
                    let aprobados =
                         locales.filter(function (local) {
                              if (local.comuna == localCapturado) {
                                   panel.innerHTML = ``
                                   return true
                              } else {
                                   // console.log('no hay coincidencias')
                                   return false
                              }
                         })
                    console.log('los aprobados son: ')
                    console.log(aprobados)
                    limpiarPins()
                    addMarker(aprobados)
               }
          }
          let showPosition = position => {
               let
                    currentPosition = {
                         lat: position.coords.latitude,
                         lng: position.coords.longitude,
                         url: "../assets/img/icon-map-u_geo.png"
                    },
                    center = new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
                    mapOptions = {
                         zoom: 5,
                         scrollwheel: false,
                         center: center,
                         mapTypeId: google.maps.MapTypeId.roadmap
                    }
               map = new google.maps.Map(mapCanvas, mapOptions)
               //   addMarker (currentPosition)
               //console.log(currentPosition)
               //   addMarker(currentPosition)
          }

          // let initialize = () => {
          //      if (navigator.geolocation) {
          //           navigator.geolocation.getCurrentPosition(showPosition);
          //      } else {
          //           console.log('no llego');
          //      }
          //      addMarker(locations)
          // }

          
           // SE CREAN TAGS POR CATEGORIA
           function tags(valor){
               //console.log(valor);
               const noRepetidas= [... new Set(valor.map(x => x.circunstanciaDeFallecimiento))];
               console.log(noRepetidas.indexOf('-'))
               barra.innerHTML = ''
               barra.innerHTML +=
               `
               ${noRepetidas.map(cat => cat.indexOf('-') == -1
                                   ? `<a class="categorias btn btn-default" id="${cat}">${cat.split('-').join(' ')}</a>`
                                   : `<a class="categorias btn btn-default" id="${cat}">${cat.split('-').join(' ')}</a>`
                                   ).join(' ')}
               `
               let categorias = document.getElementsByClassName('categorias')
               
               for (i = 0; i < categorias.length; i++) {
                    categorias[i].addEventListener("click", getProduct,false);
                    }
               function getProduct(e){
                    let elementoClikeado = e.target.getAttribute('id')
                    console.log(elementoClikeado)

                    datosSeleccionados = valor.filter( (catSeleccionada) => {
                         if(catSeleccionada.circunstanciaDeFallecimiento == elementoClikeado){
                              return true
                         } else {console.log('no hay coincidencias con id del btn')}
                    })
                    console.log(datosSeleccionados)
                    
                    panel.innerHTML = ''
                    panel.innerHTML += `a`
                    // ${datosSeleccionados.map(dat => {
                    //      `<a style="display: block;"class="marker-link" onclick="myClick(${markers.length -1});">
                    //           <h2>${dat.nombre}</h2>
                    //           ${ !dat.circunstanciaDeFallecimiento ? "" : `<p><b>Circunstancias:</b> ${dat.circunstanciaDeFallecimiento}</p>`}

                    //           ${ !dat.edad ? "" : `<p><b>edad:</b> ${dat.edad}</p>`}

                    //           ${ !dat.nacionalidad ? "" : `<p><b>nacionalidad:</b> ${dat.nacionalidad}</p>`}

                    //           ${ !dat.fecha ? "" : `<p><b>fecha:</b> ${dat.fecha}</p>`}

                    //           ${ !dat.lugar ? "" : `<p><b>lugar:</b> ${dat.lugar}</p>`} 
                    //       </a>
                    //      `})}
                    // `
                         }

          }
          //CIERRE SE CREAN TAGS POR CATEGORIA
          const initMap = () => {
               map = new google.maps.Map(mapCanvas, {
                    zoom: 5,
                    center: chileCords,
                    scrollwheel: false,
                    mapTypeId: google.maps.MapTypeId.ROADMAP
               })
               const iniciarLocales = () => {
                    fetch(jsonLocales)
                         .then(
                              fail = (res) => {
                                   /* get the data as a Blob */
                                   if (!res.ok) throw new Error("fetch failed");
                                   return res.arrayBuffer();
                              }
                         )
                         .then(
                              load = (ab) => {
                                   /* parse the data when it is received */
                                   let data = new Uint8Array(ab);
                                   let workbook = XLSX.read(data, {
                                        type: "array"
                                   });
                                   /* DO SOMETHING WITH workbook HERE */
                                   let
                                        first_sheet_name = workbook.SheetNames[0];
                                   /* Get worksheet */
                                   let
                                        worksheet = workbook.Sheets[first_sheet_name];
                                   locales = XLSX.utils.sheet_to_json(worksheet, {
                                        raw: true
                                   })

                                   addMarker(locales)
                                   ,console.log(locales)
                                   ,tags(locales)
                              }
                         )
               }
               iniciarLocales()
          }
          initMap()
          //  initialize()
     </script>
</body>

</html>